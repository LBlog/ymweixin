<include file="Public:head" />
<link rel="stylesheet" href="{pigcms::STATICS}/kindeditor/themes/default/default.css" />
<link rel="stylesheet" href="{pigcms::STATICS}/kindeditor/plugins/code/prettify.css" />
<script src="{pigcms::STATICS}/kindeditor/kindeditor.js" type="text/javascript"></script>
<script src="{pigcms::STATICS}/kindeditor/lang/zh_CN.js" type="text/javascript"></script>
<script src="{pigcms::STATICS}/kindeditor/plugins/code/prettify.js" type="text/javascript"></script>
<script src="/tpl/static/artDialog/jquery.artDialog.js?skin=default"></script>
<script src="/tpl/static/artDialog/plugins/iframeTools.js"></script>

<script type="text/javascript" src="/tpl/static/ueditor/ueditor.config.js"></script>
<script type="text/javascript" src="/tpl/static/ueditor/ueditor.all.js"></script>
<script type="text/javascript" charset="utf-8" src="/tpl/static/ueditor/lang/zh-cn/zh-cn.js"></script>  
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=MyhGiIiNiKxzyptRzo4XOdxwNM843snY"></script>
<script>
var editor;
KindEditor.ready(function(K) {
editor = K.create('#intro', {
resizeType : 1,
allowPreviewEmoticons : false,
allowImageUpload : true,
uploadJson : '/index.php?g=User&m=Upyun&a=kindedtiropic',
items : [
'source','undo','clearhtml','hr',
'removeformat', '|', 'justifyleft', 'justifycenter', 'justifyright', 'insertorderedlist',
'insertunorderedlist', '|', 'emoticons', 'image','link', 'unlink','baidumap','lineheight','table','anchor','preview','print','template','code','cut', 'music', 'video','|', 'forecolor', 'hilitecolor', 'bold', 'italic', 'underline','hr', 'fontname', 'fontsize'],
afterBlur: function(){this.sync();}
});
});
</script>
  <div class="content"> 
   <div class="cLineB"> 
    <h4>增加兑换点</h4> 
    <a href="{pigcms::U('Apiext/extlist',array('token'=>$token))}" class="right  btnGreen" style="margin-top:-27px">返回</a> 
   </div>
	<div style="background:#fefbe4;border:1px solid #f3ecb9;color:#993300;padding:10px;margin-top:5px;">
	<span>温馨提示：</span>
	<p>兑换点添加功能模块</p>
	</div> 
<form method="post" action="" id="formID">
    <div class="msgWrap bgfc"> 
     <table class="userinfoArea" style=" margin:0;" border="0" cellspacing="0" cellpadding="0" width="100%"> 
      <tbody> 
       <tr> 
        <th><span class="red">*</span>名称：</th> 
        <td>
      <!--   <input type="hidden" name="pid" id="pid" value=""/> -->
        <input type="text" name="title" id="title" value="" class="px" style="width:400px;" />
        </td> 
       </tr> 
  
  		 <tr> 
        <th><span class="red">*</span>联系方式：</th> 
        <td>
        <!-- <input type="hidden" name="pid" id="pid" value=""/> -->
        <input type="text" name="tel" id="tel" value="" class="px" style="width:200px;" />
        </td> 
       </tr> 
      
       <tr>
         	 <th>上传图片：</th>
        	<td>
            	<div class="col-sm-3"> 
             		 <div id="pimg_div"><img src="" style="max-height:100px; margin-bottom:0.5rem;"/></div> 
                	<input  type="button" class="datepicker" onclick="upImage('pimg','1');" value="上传图片" />
                	<span style="color:red;">（最多上传6张图片,请上传合适的尺寸）</span>
                	<input type="hidden" class="form-control" id="pimg" name="img">      
           	    </div>
      	 	</td>
       </tr>

       <tr> 
        <th>排序：</th> 
        <td><input type="text" id="score" name="score" value="{pigcms:$set.score}" class="px" style="width:50px;" />  数字越小排再越前（大于等于0的整数）</td> 
       </tr>
       <TR>
          <TH valign="top"><label for="info">详细页内容：</label></TH>
          <TD><textarea name="content" id="content" rows="5" style="border:1px solid #999;width:590px;height:360px">{pigcms:$set.intro}</textarea></TD>
       </TR>
		
		<TR>
          <TH valign="top"><label for="info">兑换地址：</label></TH>
          <TD>
          <input type="text" id="addr" name="addr" value="" class="px" style="width:200px;" /> <a href="javascript:void(0)" class="btnGray" id="getpos" >搜索</a>
          <span style="margin-left:20px"><font size="2px">兑换点经纬度:</font> <input type="text" id="position" name="position" value="" class="px" style="width:200px;" readonly /></span>
          </TD>
       </TR>
		
		<tr>         
       	<td colspan="2" style="width:600px;height:400px">
       	<div  id="allmap" style="width:100%;height:100%;overflow;hidden;margin:0;font-family:'微软雅黑';"></div>
       	</td>
       </tr> 
		
       <tr>         
       <th>&nbsp;</th>
       <td>
       <button type="button" name="button" class="btnGreen" id="save">保存</button> &nbsp; <a href="{pigcms::U('Store/index',array('token'=>$token, 'catid' => $catid))}" class="btnGray vm">取消</a></td> 
       </tr> 
      </tbody> 
     </table> 
     </div>
</form>
  </div> 
  
  
  <!-- 点击来输入地址 -->
  
  <script type="text/javascript">
  $(function(){
	  $("#getpos").click(function(){
		var addr = $("#addr").val();
		var lng = "{pigcms:$item.longitude}";
		var lat = "{pigcms:$item.latitude}";
		var addr = $("#addr").val();
		if(!addr)
		{
			alert('请输入地址!');
			return false;
		}
		bmap(addr,lng,lat);
	  })
  })
  
  //百度地图api
  function bmap(obj,lng="",lat='')
  {
		// 百度地图API功能
		var map = new BMap.Map("allmap");  // 创建Map实例
		var res = map.centerAndZoom(obj,15);      // 初始化地图,用城市名设置地图中心点
		map.enableScrollWheelZoom();   //启用滚轮放大缩小，默认禁用
		map.enableContinuousZoom();    //启用地图惯性拖拽，默认禁用
		//单击获取点击的经纬度
		map.addEventListener("click",function(e){
			//alert(e.point.lng + "," + e.point.lat);
			var pos = e.point.lng + "," + e.point.lat;
			$("#position").val(pos);
			lng = e.point.lng;
			lat=e.point.lat;
			var marker = new BMap.Marker(new BMap.Point(lng, lat));
			console.log(marker);
			remove_overlay();
			add_overlay(marker);
		})
	
		
		
		//添加覆盖物
		function add_overlay(marker){
			map.addOverlay(marker);            //增加点
		}
		//清除覆盖物
		function remove_overlay(){
			map.clearOverlays();         
		}
		
		
		
		
  }

</script>
  
  
  <script type="text/javascript" id="j_ueditorupload"></script>
<script type="text/javascript">
    var gimgid='';
    var gis_more='';

    //建议使用工厂方法getEditor创建和引用编辑器实例，如果在某个闭包下引用该编辑器，直接调用UE.getEditor('editor')就能拿到相关的实例
    var ue = UE.getEditor('editor');
    
    //实例化编辑器
    var o_ueditorupload = UE.getEditor('j_ueditorupload');
    o_ueditorupload.ready(function () {
      o_ueditorupload.hide();//隐藏编辑器     
      //监听图片上传
      o_ueditorupload.addListener('beforeInsertImage', function (t,arg){
        if(gis_more=='0'){
          $("#"+gimgid).val(arg[0].src);
          $("#"+gimgid+'_url').attr('src',arg[0].src);
        }else{
          var html ='';
          var img_value='';
          var num = arg.length;
          if(num > 6){
        	  alert("您上传的图片超过6张!");return false;
          }else{
        	  for(var i=0;i<num;i++){
  	            img_value+=arg[i].src+',';
  	            html+='<img src="'+arg[i].src+'"style="max-height:100px; margin:0 1rem 1rem 0;"/>';
  	          }
          }
          $("#"+gimgid+"_div").html(html);
          $("#"+gimgid).val(img_value);
        }          
      });  
      /* 文件上传监听
       * 需要在ueditor.all.min.js文件中找到
       * d.execCommand("insertHtml",l)
       * 之后插入d.fireEvent('afterUpfile',b)
       */
      o_ueditorupload.addListener('afterUpfile', function (t, arg){
            
      });
    });
       
    //弹出图片上传的对话框
    function upImage(imgid,is_more){
      gimgid=imgid;
      gis_more=is_more;
      var myImage = o_ueditorupload.getDialog("insertimage");
      myImage.open();
    }
    //弹出文件上传的对话框
    function upFiles(){
      var myFiles = o_ueditorupload.getDialog("attachment");
      myFiles.open();
    } 
</script>

  
  
  
<script type="text/javascript">
$(document).ready(function(){

	$("#save").click(function(){
		var title = $('#title').val();
		var tel = $('#tel').val();
		var img = $("#pimg").val();
		var addr = $("#addr").val();
		var position = $("#position").val();
		var content = $("#content").val();
		var score = $("#score").val();


		if(title==null|| title==''){
			alert('请填写兑换点名称');
			return;
		}
		if(tel==null|| tel==''){
			alert('请填写兑换点联系方式');
			return;
		}
		
		var data = {
				title:title,
				tel:tel,
				img:img,
				addr:addr,
				position:position,
				content:content,
				score:score,
				token:'{pigcms:$token}',
				};
	$.post('index.php?g=User&m=Apiext&a=save_ext', data, function(response){
		if (response.error_code == false) {
			art.dialog({
				title:'消息提示', 
			    content: response.msg, 
			    width:300, 
			    height:200,
			    lock: true,
			    ok: function () {
			    	this.time(3);
			    	location.href="index.php?g=User&m=Apiext&a=extlist&token={pigcms:$token}";
			        return false;
			    },
			    cancelVal: '关闭'
			});
		} else {
			art.dialog({title:'消息提示', time:2, width:300, height:200, content:response.msg});
		}
		
	}, 'json');
    })
});
</script>
<include file="Public:footer" />